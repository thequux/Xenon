VERBOSE=
$(phony default): boot.img

include std-defs.mk
prebuild += tools/ccdv


boot.img: krnl-s menu.lst boot.img.tmpl
	cp boot.img.tmpl boot.img
	mount -o loop boot.img /mnt/floppy
	cat krnl-s | gzip -9 > /mnt/floppy/boot/krnl-1.gz
	cp menu.lst /mnt/floppy/boot/grub/menu.lst
	umount /mnt/floppy

tools/ccdv: tools/ccdv.c
	gcc -o tools/ccdv tools/ccdv.c

krnl-s: krnl
	@ccdv objcopy -g krnl krnl-s

krnl: asm/built-in.o misc/built-in.o hardware/built-in.o link.ld
	@ccdv ld  $(LDFLAGS) -o $@ $(filter-out link.ld, $^) -Map krnl.map
	@ccdv tools/map2sym.sh krnl.map krnl.sym

$(phony clean):
	-rm  $(filter_out boot.img, $(only_targets **/*)) krnl.map krnl.sym  2>/dev/null
#	vim: filetype=make
